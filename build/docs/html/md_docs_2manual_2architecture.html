<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ripples: Architecture</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Ripples<span id="projectnumber">&#160;1.0</span>
   </div>
   <div id="projectbrief">High Performant Software Architecture For Transaction Processing</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_2manual_2architecture.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Architecture</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md1">Datagram traversal through the application</a></li>
<li class="level1"><a href="#autotoc_md2">Sharing resources amongst threads</a></li>
<li class="level1"><a href="#autotoc_md3">Offloading logging to dedicated threads: applciation log, query log</a></li>
<li class="level1"><a href="#autotoc_md4">TCP timeouts</a></li>
<li class="level1"><a href="#autotoc_md5">Balancing TCP vs UDP request processing</a></li>
<li class="level1"><a href="#autotoc_md6">Metrics</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="autotoc_md0"></a></p>
<div class="image">
<object type="image/svg+xml" data="software_architecture.svg" style="pointer-events: none;"></object>
<div class="caption">
Software Architecture Diagram</div></div>
    <p>It is known and has been proven that establishing CPU affinity when processing network transactions achieves high system performance. To do so network data, or datagram, should be processed on the same CPU by kernel and user space application. By default network interface cards (NIC) use a single circular buffer, also known as qring, where they store received (RX) packets. Most modern NICs support configuring multiple RX buffers, one per CPU core, so processing could be spread out across multiple CPU cores. NICs use a 4 or 5 point tuple hash to steer packets for a TCP or UDP flow to the same RX buffer so a unique flow is always processed by the same CPU. There are various flow steering technologies such as RSS, RPS, RFS. For details on these see Linux networking documentation. Application can use multiple threads, each bound to a CPU core, to handle datagram processing. This way network packets for a specific flow are always handled by the same thread, reducing the need to keep an application wide connection flow context. This also simplifies software code, as same code that runs on a single thread and processes network connection data could be invoked to run on multiple number of threads.</p>
<p>All possible tasks should be offloaded to other threads, so the transaction processing thread does not need to be unnecessarily blocked by doing non critical processing. Amongst others, this includes resource management and logging.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Datagram traversal through the application</h1>
<p>The core concept of Ripples is a Vectorloop. This is a continuously running loop with following steps done each loop iteration:</p>
<ul>
<li>check if there are messages from other threads it should handle (resource changes)</li>
<li>read data from network sockets</li>
<li>parse data into DNS queries</li>
<li>resolve DNS queriers into answers</li>
<li>pack answers (encode into format suitable for transmission)</li>
<li>send DNS responses</li>
<li>log DNS queries</li>
</ul>
<p>Each step is done against a vector of data to optimize use of primed CPU cache. This provides better performance than if these steps are done one query at a time.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Sharing resources amongst threads</h1>
<p>Ripples application is an authoritative DNS server. DNS servers use zones for data needed to respond to a query. Modern servers also use a GeoIP location database to find out where the request originated from so they could provide a response that is closest to the origination point. DNS and GeoIP databases are just some of the resources a server would use. These resources are usually in memory, could take large amounts of space (disk or RAM), and also are subject to constant change. Application needs to be able to absorb resource changes without impact on performance. The efficient way to handle shared resources is to have a single thread, one that does not process DNS queries, handle loading of resource into memory when resource changes. Once an updated resource is loaded into its own memory space, each thread is notified that it should switch from using the old resource data to using the newly loaded resource data. This is usually just a pointer switch. Once all threads process the pointer switch old data can be released (memory freed). This approach works well for resources that are read only.</p>
<p>Ripples uses liblfds (lock free data structures) to create channels for inter thread communication.</p>
<p>A dummy "resource_1" is present in ripples to demonstrate this approach.</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Offloading logging to dedicated threads: applciation log, query log</h1>
<p>Threads that process queries should not have any blocking actions on them, such as reading from or writing to disk. All such actions should be offloaded to separate threads dedicated for the task.</p>
<p>Ripples offloads application logging to a dedicated thread via use of channels (liblfds). Each thread sends a message to application logging thread with message that should be logged. These are one way channels as application logging thread only receives messages over channels.</p>
<p>For query logging Ripples uses dual buffers to log DNS queries, there is an active and standby buffer. Queries are logged by vectorloop into active buffer. There is a dedicated thread that writes data from these buffers to disk. This dedicated thread notifies vectorloop thread that it should switch (flip) its active and standby buffers. Once the flip is done the inactive (standby) buffer is accessed by logging thread and data from the buffer written to disk. When data is written to disk the process repeats and buffers are flipped once again.</p>
<h1><a class="anchor" id="autotoc_md4"></a>
TCP timeouts</h1>
<p>To avoid costly timer and callbacks implementation, ripples uses a Least Recently Used (LRU) Cache. Each vectorloop iteration the cache is checked, starting with the oldest entry in cache, if timeout was reached. Currently, the only timeouts Ripples implements are one relating to TCP connections.</p>
<h1><a class="anchor" id="autotoc_md5"></a>
Balancing TCP vs UDP request processing</h1>
<p>TCP requests are received over TCP connections where each connection has its own socket. UDP requests are received over a single socket. To balance the ratio of TCP vs UDP queries processed each <b>vectorloop iteration</b>, the following exist:</p>
<ul>
<li>There are two epoll file descriptors, one for TCP, and one for UDP. Number of events each epoll fd returns per epoll_wait() call is tunable.</li>
<li>Number of UDP datagrams (packets) read in via a single call to recvmmsg() is tunable</li>
<li>Number of new TCP connections accepted is tunable</li>
<li>TCP is a stream of data and it is possible that a single read from socket resulted in multiple queries read in. Number of simultaneous queries to process per TCP connection is tunable.</li>
</ul>
<p>For a full list of Ripples options see Usage.</p>
<h1><a class="anchor" id="autotoc_md6"></a>
Metrics</h1>
<p>Application metrics are stored in a single metrics object. It is fairly simple to create a dedicated thread that at a cadence reports (writes to disk, or sends over network) metrics and also resets the metric counters. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
